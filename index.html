<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#000000">

    <title>Terapia VR S24</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            background-color: black;
            overflow: hidden;
            display: flex;
            height: 100vh;
            width: 100vw;
            font-family: Arial, sans-serif;
        }

        .eye {
            width: 50%;
            height: 100%;
            position: relative;
            overflow: hidden;
            border-right: 1px solid #111;
        }

        video {
            width: 100%;
            height: 100%;
            object-fit: cover; /* Estira la imagen */
            transform: scaleX(-1); /* EFECTO ESPEJO */
        }

        /* Pantalla de inicio */
        #pantallaInicio {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: black;
            z-index: 100;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: white;
            text-align: center;
        }

        .btn-grande {
            padding: 20px 40px;
            font-size: 22px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 50px;
            margin-top: 20px;
            box-shadow: 0 0 20px rgba(0,123,255,0.5);
        }

        /* Botón discreto para cambiar cámara */
        #btnCambio {
            display: none; 
            position: absolute;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 50;
            background: rgba(255,255,255,0.2);
            border: 2px solid white;
            color: white;
            padding: 15px 30px;
            font-size: 16px;
            border-radius: 30px;
            backdrop-filter: blur(5px);
            font-weight: bold;
            box-shadow: 0 4px 10px rgba(0,0,0,0.5);
        }
    </style>
</head>
<body>

    <div id="pantallaInicio">
        <h1>Terapia Espejo VR</h1>
        <p>Versión S24 Fullscreen</p>
        <button class="btn-grande" onclick="arrancarTodo()">INICIAR APP</button>
    </div>

    <button id="btnCambio" onclick="siguienteCamara()">CAMBIAR CÁMARA ↻</button>

    <div class="eye"><video id="videoL" playsinline autoplay muted></video></div>
    <div class="eye"><video id="videoR" playsinline autoplay muted></video></div>

    <script>
        let streamActual = null;
        let listaCamaras = [];
        let indiceCamara = 0;

        // Función para forzar pantalla completa agresivamente
        function forzarFullscreen() {
            let elem = document.documentElement;
            if (!document.fullscreenElement) {
                if (elem.requestFullscreen) { elem.requestFullscreen().catch(err => console.log(err)); }
                else if (elem.webkitRequestFullscreen) { elem.webkitRequestFullscreen(); }
                else if (elem.msRequestFullscreen) { elem.msRequestFullscreen(); }
            }
        }

        async function arrancarTodo() {
            forzarFullscreen(); // Fullscreen al iniciar

            document.getElementById('pantallaInicio').style.display = 'none';
            document.getElementById('btnCambio').style.display = 'block';

            try {
                // Permisos iniciales
                await navigator.mediaDevices.getUserMedia({ video: true });
                
                // Listar cámaras
                const dispositivos = await navigator.mediaDevices.enumerateDevices();
                listaCamaras = dispositivos.filter(d => d.kind === 'videoinput');

                if (listaCamaras.length === 0) {
                    alert("No se detectan cámaras.");
                } else {
                    cargarCamara(0);
                }

                // Evitar bloqueo pantalla
                if ('wakeLock' in navigator) {
                    try { await navigator.wakeLock.request('screen'); } catch(e){}
                }

            } catch (err) {
                alert("Error: " + err.message);
                document.getElementById('pantallaInicio').style.display = 'flex';
            }
        }

        async function cargarCamara(index) {
            // Detener stream previo
            if (streamActual) {
                streamActual.getTracks().forEach(track => track.stop());
            }

            let camara = listaCamaras[index];
            
            try {
                const constraints = {
                    video: { deviceId: { exact: camara.deviceId } },
                    audio: false
                };

                streamActual = await navigator.mediaDevices.getUserMedia(constraints);
                
                document.getElementById('videoL').srcObject = streamActual;
                document.getElementById('videoR').srcObject = streamActual;

                document.getElementById('btnCambio').innerText = `CÁMARA ${index + 1}/${listaCamaras.length} (Cambiar)`;

            } catch (err) {
                console.error(err);
                alert("Error al cargar esta cámara, pasa a la siguiente.");
            }
        }

        function siguienteCamara() {
            // ¡AQUÍ ESTÁ LA CLAVE!
            // Cada vez que pulsas el botón, re-forzamos pantalla completa antes de nada
            forzarFullscreen();

            if (listaCamaras.length < 1) return;
            
            indiceCamara++;
            if (indiceCamara >= listaCamaras.length) {
                indiceCamara = 0;
            }
            
            cargarCamara(indiceCamara);
        }
    </script>
</body>
</html>
