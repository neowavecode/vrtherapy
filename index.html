<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#000000">
    <link rel="manifest" href="data:application/manifest+json;base64,ewogICJuYW1lIjogIlRlcmFwaWEgVlIiLAogICJzaG9ydF9uYW1lIjogIlRlcmFwaWEiLAogICJkaXNwbGF5IjogInN0YW5kYWxvbmUiLAogICJiYWNrZ3JvdW5kX2NvbG9yIjogIiMwMDAwMDAiLAogICJ0aGVtZV9jb2xvciI6ICIjMDAwMDAwIgp9">

    <title>Terapia VR</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            background-color: black;
            overflow: hidden;
            display: flex;
            height: 100vh;
            width: 100vw;
            font-family: Arial, sans-serif;
        }

        .eye {
            width: 50%;
            height: 100%;
            position: relative;
            overflow: hidden;
            border-right: 1px solid #111;
        }

        video {
            width: 100%;
            height: 100%;
            object-fit: cover; /* Estira la imagen para llenar todo */
            transform: scaleX(-1); /* EFECTO ESPEJO */
        }

        /* Pantalla de inicio */
        #pantallaInicio {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: black;
            z-index: 100;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: white;
            text-align: center;
        }

        /* Botón Grande de Inicio */
        .btn-grande {
            padding: 20px 40px;
            font-size: 22px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 50px;
            margin-top: 20px;
            box-shadow: 0 0 20px rgba(0,123,255,0.5);
        }

        /* Botón discreto para cambiar cámara */
        #btnCambio {
            display: none; /* Se oculta al principio */
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 50;
            background: rgba(255,255,255,0.3);
            border: 2px solid white;
            color: white;
            padding: 15px 30px;
            font-size: 18px;
            border-radius: 30px;
            backdrop-filter: blur(5px);
        }
    </style>
</head>
<body>

    <div id="pantallaInicio">
        <h1>Terapia Espejo</h1>
        <p>1. Pulsa el botón<br>2. Da permisos a la cámara</p>
        <button class="btn-grande" onclick="arrancarTodo()">INICIAR APP</button>
    </div>

    <button id="btnCambio" onclick="siguienteCamara()">CAMBIAR CÁMARA ↻</button>

    <div class="eye"><video id="videoL" playsinline autoplay muted></video></div>
    <div class="eye"><video id="videoR" playsinline autoplay muted></video></div>

    <script>
        let streamActual = null;
        let listaCamaras = [];
        let indiceCamara = 0;

        async function arrancarTodo() {
            // 1. Intentar poner Pantalla Completa
            let elem = document.documentElement;
            if (elem.requestFullscreen) { elem.requestFullscreen().catch(e => console.log(e)); }
            else if (elem.webkitRequestFullscreen) { elem.webkitRequestFullscreen(); }

            // 2. Ocultar pantalla inicio
            document.getElementById('pantallaInicio').style.display = 'none';
            document.getElementById('btnCambio').style.display = 'block';

            // 3. Obtener cámaras
            try {
                // Pedimos permiso genérico primero
                await navigator.mediaDevices.getUserMedia({ video: true });
                
                // Listamos TODO lo que sea video
                const dispositivos = await navigator.mediaDevices.enumerateDevices();
                listaCamaras = dispositivos.filter(d => d.kind === 'videoinput');

                if (listaCamaras.length === 0) {
                    alert("No se detectan cámaras.");
                } else {
                    // Iniciamos la primera de la lista
                    cargarCamara(0);
                }

                // Bloqueo de pantalla para que no se apague
                if ('wakeLock' in navigator) {
                    try { await navigator.wakeLock.request('screen'); } catch(e){}
                }

            } catch (err) {
                alert("Error: " + err.message);
                document.getElementById('pantallaInicio').style.display = 'flex';
            }
        }

        async function cargarCamara(index) {
            // Detenemos la cámara anterior si existe
            if (streamActual) {
                streamActual.getTracks().forEach(track => track.stop());
            }

            // Seleccionamos la cámara de la lista
            let camara = listaCamaras[index];
            
            try {
                // NO pedimos resolución específica para evitar fallos. 
                // Que la cámara nos de lo que tenga por defecto.
                const constraints = {
                    video: { deviceId: { exact: camara.deviceId } },
                    audio: false
                };

                streamActual = await navigator.mediaDevices.getUserMedia(constraints);
                
                document.getElementById('videoL').srcObject = streamActual;
                document.getElementById('videoR').srcObject = streamActual;

                // Feedback visual en el botón
                document.getElementById('btnCambio').innerText = `CÁMARA ${index + 1} / ${listaCamaras.length} (Cambiar)`;

            } catch (err) {
                console.error(err);
                alert("Error al cargar cámara " + (index+1));
            }
        }

        function siguienteCamara() {
            if (listaCamaras.length < 1) return;
            
            // Sumamos 1 al índice. Si llegamos al final, volvemos a 0.
            indiceCamara++;
            if (indiceCamara >= listaCamaras.length) {
                indiceCamara = 0;
            }
            
            cargarCamara(indiceCamara);
        }
    </script>
</body>
</html>
